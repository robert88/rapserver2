"use strict";

const toReg = require("./toReg.js");

module.exports = function (fn, replaceKeyWords) {
	
  var str = fn.toString();
  let code = "";
  let arg="";
  str.replace(/^\s*async(\s*[^\{]+)\{([\u0000-\uFFFF]*)\}$/igm, function(m,m1,m2){
	  arg = m1.replace(/^[^\(]+\(([\u0000-\uFFFF]*)\)\s*$/,"$1");
	  code = m2;
  });
  if(code==""||str==code){
	  throw Error("can not find async function!");
  }
  //手动替换
  if (replaceKeyWords) {
    if (typeof replaceKeyWords == "object") {
      code = code.replace(/(\b)await\s/g, "$1");
      replaceKeyWords.forEach(keyword => {
        code = code.replace(new RegExp(toReg.call(keyword), "g"), keyword + "Sync");
      })
    } else {
      code = code.replace(new RegExp(toReg.call(replaceKeyWords), "g"), replaceKeyWords + "Sync");
    }

  }

  //自动替换
  code = code.replace(/(\b)await(\s*[^\(]+)\(/igm, "$1$2Sync(");

  return new Function(`return function(${arg}){${code}}`)();

}
